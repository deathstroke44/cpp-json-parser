processResult():
    result = AppendResultsByCommaSeparators()
    if multipleResultQuery:
        result = "[" + result + "]"
    RETURN result

updateResult(streamToken, key):
    resultUpToNowForThisKey = jsonPathQueryResultKeys.get(key)
    lastAddedToken = jsonPathQueryResultsLastAddedTokenMap.get(key)
    IF appendingDelimiterNeeded(streamToken, lastAddedToken):
        lastAddedToken.append(",")
    lastAddedToken.append(getProcessedValue(streamToken));

updateResultIfNeeded(streamToken, ignoreEventFlag, shouldAddThisEvent, previousKeySatisfy, previousKey):
    currentKeySatisfy = isCurrentJsonPathMatchJsonPathQuery();
    IF currentKeyMatched and not ignoreEventFlag:
        currentKey = getCurrentJsonPathUptoQueryLength()
        updateResult(streamToken, currentKey)
    ELSE IF (not currentKeySatisfy and shouldAddThisEvent and previousKeySatisfy)
        updateResult(streamToken, previousKey)

processStreamTokenAndUpdateStates(streamToken, shouldAddThisEvent, ignoreEventFlag)
    IF streamToken.type == KEY_TOKEN:
        key=Key(isStringKey=false,index=-streamToken.value)
        ignoreEventFlag = ignoreEventFlag || !currentJsonPathMatchJsonPathQuery()
        currentJsonPathStack.push({isStringKey:true, key: streamToken.value})
    ELSE IF streamToken.type == VALUE_TOKEN:
        IF PartOfObject:
            currentJsonPathStack.pop()
            shouldAddThisEvent = true
        ELSE IF PartOfList:
            currentJsonPathStack.top().index++
    ELSE IF streamToken.type == LIST_STARTED_TOKEN:
        IF PartOfList:
            currentJsonPathStack.top().index++
        currentJsonPathStack.push({isStringKey=false,index=-1})
        traversingListOrObjectStack.push("list")
    ELSE IF streamToken.type == LIST_ENDED_TOKEN:
        currentJsonPathStack.pop()
        IF PartOfObject:
            currentJsonPathStack.pop()
        shouldAddThisEvent=isCurrentTokenLastCharacterOfKeysValue();
    ELSE IF streamToken.type == OBJECT_STARTED_TOKEN:
        IF PartOfList:
            currentJsonPathStack.top().index++
        traversingListOrObjectStack.push("object")
    ELSE IF streamToken.type == OBJECT_ENDED_TOKEN:
        traversingListOrObjectStack.pop()
        IF PartOfObject:
            currentJsonPathStack.pop()
        shouldAddThisEvent=true

handleEvent(streamToken):
    IF streamToken.tokenType == DOCUMENT_END:
        processResult()
        RETURN
    shouldAddThisEvent = ignoreEventFlag = false;
    previousKeySatisfy = isCurrentJsonPathMatchJsonPathQuery();
    processStreamTokenAndUpdateStates(streamToken, shouldAddThisEvent, ignoreEventFlag);
    updateResultIfNeeded(streamToken, ignoreEventFlag, shouldAddThisEvent, previousKeySatisfy, previousKey);